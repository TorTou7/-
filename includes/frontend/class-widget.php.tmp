<?php
/**
 * è‡ªåŠ©å¹¿å‘Šä½ Widget ç±» - æœåŠ¡å™¨ç«¯æ¸²æŸ“æ¶æ„ï¼ˆä¸¥æ ¼éµå¾ªå¼€å‘æ–¹æ¡ˆï¼‰
 *
 * æ¶æ„è®¾è®¡æ€æƒ³ï¼š
 * ================
 * 1. æœåŠ¡å™¨ç«¯æ¸²æŸ“ï¼ˆSSRï¼‰
 *    - Widget ç›´æ¥è¾“å‡ºå®Œæ•´ HTML ç»“æ„ï¼ˆ<a><img> æˆ–æ–‡å­—é“¾æ¥ï¼‰
 *    - SEO å‹å¥½ï¼Œæœç´¢å¼•æ“å¯çˆ¬å–å¹¿å‘Šå†…å®¹
 *    - é¦–å±æ¸²æŸ“å¿«é€Ÿï¼Œæ— éœ€ç­‰å¾… JS åŠ è½½
 *
 * 2. ä¸»é¢˜é›†æˆ
 *    - å¤ç”¨ Zib_CFSwidget å°è£…ï¼ˆæ ‡é¢˜ã€æ˜¾ç¤ºè§„åˆ™ï¼‰
 *    - ä½¿ç”¨ä¸»é¢˜æ ·å¼ç±» .theme-boxã€.zib-widget
 *    - å…¼å®¹ä¸»é¢˜å“åº”å¼å¸ƒå±€ç³»ç»Ÿ
 *
 * 3. å¸ƒå±€ç³»ç»Ÿ
 *    - CSS Grid å¸ƒå±€ï¼ˆ--per-row è‡ªå®šä¹‰å±æ€§ï¼‰
 *    - ç©ºä½æ·»åŠ  .is-empty ç±»å’Œ data-* å±æ€§
 *    - å“åº”å¼æ–­ç‚¹æ”¯æŒï¼ˆç§»åŠ¨ç«¯/PCç«¯ï¼‰
 *
 * 4. æ€§èƒ½ä¼˜åŒ–ç­–ç•¥
 *    - ç¼“å­˜æ¸²æŸ“åçš„å®Œæ•´ HTMLï¼ˆtransientï¼‰
 *    - è®¢å•å˜æ›´æ—¶ç²¾å‡†æ¸…é™¤å¯¹åº”ç¼“å­˜
 *    - æ”¯æŒå¤šå®ä¾‹é¡µé¢ä¼˜åŒ–
 *
 * 5. æ¸è¿›å¢å¼º
 *    - å‰ç«¯ JS ä»…è´Ÿè´£è´­ä¹°äº¤äº’ï¼ˆå¯é€‰ï¼‰
 *    - ç¦ç”¨ JS æ—¶å¹¿å‘Šä½ä»å¯æ­£å¸¸å±•ç¤º
 *    - ç©ºä½ç‚¹å‡»äº‹ä»¶ç”± jQuery å¤„ç†
 *
 * @package Zibll_Ad
 * @version 1.0.0
 * @see å¼€å‘æ–¹æ¡ˆ.txt æ­¥éª¤ 3.1
 */

// ç¦æ­¢ç›´æ¥è®¿é—®
if (!defined('ABSPATH')) {
    exit;
}

/**
 * è‡ªåŠ©å¹¿å‘Šä½ Widget ç±»
 *
 * éµå¾ªå¼€å‘æ–¹æ¡ˆï¼š
 * - ç»§æ‰¿ WP_Widgetï¼ˆå¯é€‰é›†æˆ Zib_CFSwidgetï¼‰
 * - æœåŠ¡å™¨ç«¯ç›´æ¥æ¸²æŸ“ HTML
 * - æ”¯æŒå›¾ç‰‡å‹å’Œæ–‡å­—å‹å¹¿å‘Šä½
 */
class Zibll_Ad_Widget extends WP_Widget {

    /**
     * æ„é€ å‡½æ•°
     */
    public function __construct() {
        parent::__construct(
            'zibll_ad_widget',
            __('å­æ¯”è‡ªåŠ©å¹¿å‘Šä½', 'zibll-ad'),
            array(
                'description' => __('å±•ç¤ºè‡ªåŠ©å¹¿å‘Šä½å†…å®¹ï¼ˆVue + Element Plusï¼‰', 'zibll-ad'),
                'classname' => 'zibll-ad-widget',
                'customize_selective_refresh' => true,
            )
        );
    }

    /**
     * å‰ç«¯è¾“å‡º - æœåŠ¡å™¨ç«¯æ¸²æŸ“å®Œæ•´ HTML
     *
     * å¼€å‘æ–¹æ¡ˆè¦æ±‚ï¼ˆæ­¥éª¤ 3.1ï¼‰ï¼š
     * - ä» $instance['slot_id'] è·å– slot é…ç½®
     * - æ£€æŸ¥ç¼“å­˜ï¼šget_transient("zibll_ad_slot_render_{$slot_id}_{$hash}")
     * - æ— ç¼“å­˜åˆ™è°ƒç”¨ Slot_Model::get_units_for_render($slot_id)
     * - æ ¹æ® slot_type æ¸²æŸ“ï¼š
     *   - å›¾ç‰‡å‹ï¼šå¾ªç¯è¾“å‡º <a href="..."><img src="..." /></a>
     *   - æ–‡å­—å‹ï¼šè¾“å‡º <a href="..." style="color:...">æ–‡å­—</a>
     * - ç©ºä½ï¼šæ·»åŠ  class="is-empty", data-slot, data-unit å±æ€§ï¼Œç»‘å®šè´­ä¹°æŒ‰é’®
     * - åº”ç”¨å¸ƒå±€æ ·å¼ï¼šstyle="--per-row:{$per_row}"ï¼Œä½¿ç”¨ CSS Grid
     * - ç¼“å­˜æ¸²æŸ“ç»“æœï¼ˆ1å°æ—¶ï¼‰
     *
     * @param array $args     Widget å‚æ•°
     * @param array $instance Widget å®ä¾‹é…ç½®
     */
    public function widget($args, $instance) {
        $slot_id = isset($instance['slot_id']) ? intval($instance['slot_id']) : 0;

        if (!$slot_id) {
            return;
        }

        // æ£€æŸ¥ Slot Model æ˜¯å¦å­˜åœ¨
        if (!class_exists('Zibll_Ad_Slot_Model')) {
            return;
        }

        $slot = Zibll_Ad_Slot_Model::get($slot_id);

        if (!$slot) {
            // ä»…ç®¡ç†å‘˜å¯è§é”™è¯¯æç¤º
            if (current_user_can('manage_zibll_ads')) {
                echo '<div class="zibll-ad-error" style="padding:20px;background:#fff3cd;border-left:4px solid #ffc107;color:#856404;">';
                echo esc_html(sprintf(__('å¹¿å‘Šä½ #%d ä¸å­˜åœ¨', 'zibll-ad'), $slot_id));
                echo '</div>';
            }
            return;
        }

        // æ£€æŸ¥æ˜¯å¦å¯ç”¨
        if (isset($slot['enabled']) && !$slot['enabled']) {
            return;
        }

        // ========================================
        // é›†æˆ Zib_CFSwidgetï¼ˆä¸»é¢˜æ ·å¼å°è£…ï¼‰
        // ========================================
        $use_zib_widget = class_exists('Zib_CFSwidget');

        // æ„å»º Zib_CFSwidget å…¼å®¹çš„ $instance å‚æ•°
        $widget_instance = array_merge($instance, array(
            'show_type' => isset($instance['show_type']) ? $instance['show_type'] : 'all',
            'title' => isset($instance['title']) ? $instance['title'] : '',
        ));

        // è§¦å‘å‰ç½®é’©å­
        do_action('zibll_ad_before_widget', $slot_id, $slot, $args, $instance);

        // ä½¿ç”¨ä¸»é¢˜æ ·å¼åŒ…è£¹
        if ($use_zib_widget) {
            // ä½¿ç”¨ Zib_CFSwidget æ ‡å‡†è¾“å‡º
            Zib_CFSwidget::echo_before($widget_instance, 'theme-box zib-widget mb20', $args);
        } else {
            // é™çº§æ–¹æ¡ˆï¼šä½¿ç”¨åŸç”Ÿ Widget å®¹å™¨
            echo $args['before_widget'];

            if (!empty($instance['title'])) {
                echo $args['before_title'];
                echo esc_html($instance['title']);
                echo $args['after_title'];
            }
        }

        // ========================================
        // æ¸²æŸ“å¹¿å‘Šä½å†…å®¹ï¼ˆæ ¸å¿ƒé€»è¾‘ï¼‰
        // ========================================
        $this->render_ad_slot_content($slot_id, $slot);

        // ä½¿ç”¨ä¸»é¢˜æ ·å¼åŒ…è£¹ç»“æŸ
        if ($use_zib_widget) {
            Zib_CFSwidget::echo_after($widget_instance, $args);
        } else {
            echo $args['after_widget'];
        }

        // è§¦å‘åç½®é’©å­
        do_action('zibll_ad_after_widget', $slot_id, $slot, $args, $instance);
    }

    /**
     * æ¸²æŸ“å¹¿å‘Šä½å†…å®¹ï¼ˆæ ¸å¿ƒæ¸²æŸ“é€»è¾‘ï¼‰
     *
     * ç”¨æˆ·éœ€æ±‚æ›´æ–°ï¼š
     * - æ–‡å­—å‹å¹¿å‘Šä½ä½¿ç”¨å…¨æ–°çš„ card æ ·å¼æ¨¡æ¿
     * - é¡¶éƒ¨æ·»åŠ  card-headï¼ˆå›¾æ ‡+æ ‡é¢˜+"ç«‹å³å…¥é©»"æŒ‰é’®ï¼‰
     * - ä½¿ç”¨ posts-row ç½‘æ ¼å¸ƒå±€
     * - æ¯ä¸ªå¹¿å‘Šå•å…ƒä¸¥æ ¼æŒ‰ç…§æ¨¡æ¿ç»“æ„è¾“å‡º
     *
     * @param int   $slot_id å¹¿å‘Šä½ ID
     * @param array $slot    å¹¿å‘Šä½é…ç½®æ•°ç»„
     */
    private function render_ad_slot_content($slot_id, $slot) {
        // ========================================
        // æ­¥éª¤ 1ï¼šæ£€æŸ¥ç¼“å­˜ï¼ˆæ”¹ä¸ºç‰ˆæœ¬åŒ– keyï¼Œé¿å… Redis ä¸‹æ¸…ç†ä¸å³æ—¶ï¼‰
        // ========================================
        // ä½¿ç”¨æ•°æ®åº“ä¸­ units çš„æœ€è¿‘æ›´æ–°æ—¶é—´ç”Ÿæˆç‰ˆæœ¬å·(hash)ï¼Œ
        // æ¯æ¬¡æŠ•æ”¾å˜åŒ–éƒ½ä¼šäº§ç”Ÿæ–° keyï¼Œä»è€Œç«‹å³å‘½ä¸­â€œç©ºç¼“å­˜â€å¼ºåˆ¶é‡æ¸²æŸ“ã€‚
        if (!function_exists('zibll_ad_generate_cache_hash')) {
            require_once ZIBLL_AD_PATH . 'includes/helpers.php';
        }
        $cache_hash = zibll_ad_generate_cache_hash($slot_id, $slot);
        $cache_key  = 'zibll_ad_slot_render_' . $slot_id . '_' . $cache_hash;
        $cached_html = (defined('ZIBLL_AD_DISABLE_CACHE') && ZIBLL_AD_DISABLE_CACHE) ? false : get_transient($cache_key);

        if (false !== $cached_html && (!defined('WP_DEBUG') || !WP_DEBUG)) {
            // ç›´æ¥è¾“å‡ºç¼“å­˜çš„ HTML
            echo $cached_html;
            return;
        }

        // ========================================
        // æ­¥éª¤ 1.5ï¼šè·å–å…¨å±€è®¾ç½®ï¼ˆæ£€æŸ¥æ˜¯å¦æš‚åœæŠ•æ”¾ï¼‰
        // ========================================
        $settings = class_exists('Zibll_Ad_Settings') ? Zibll_Ad_Settings::get_all() : array();
        $global_pause_purchase = isset($settings['global_pause_purchase']) ? (bool) $settings['global_pause_purchase'] : false;

        // ========================================
        // æ­¥éª¤ 2ï¼šè·å– units æ•°æ®
        // ========================================
        $units = Zibll_Ad_Slot_Model::get_units_for_render($slot_id);

        // æå–é…ç½®
        $slot_type = isset($slot['slot_type']) ? $slot['slot_type'] : 'image';
        $display_layout = isset($slot['display_layout']) ? $slot['display_layout'] : array();
        $default_media = isset($slot['default_media']) ? $slot['default_media'] : array();
        $text_color_options = isset($slot['text_color_options']) ? $slot['text_color_options'] : array();

        // å¸ƒå±€é…ç½®
        $per_row = isset($display_layout['per_row']) ? intval($display_layout['per_row']) : 4;
        $per_row = max(1, min(8, $per_row)); // æ”¯æŒ 1-8 åˆ—

        $rows = isset($display_layout['rows']) ? intval($display_layout['rows']) : 2;
        $rows = max(1, $rows);

        $max_display = $rows * $per_row;

        // ========================================
        // æ­¥éª¤ 3ï¼šå¼€å§‹æ¸²æŸ“ HTMLï¼ˆæ•è·åˆ°ç¼“å†²åŒºï¼‰
        // ========================================
        ob_start();

        // æ–‡å­—å‹ä½¿ç”¨æ–°æ¨¡æ¿ï¼Œå›¾ç‰‡å‹ä¿æŒåŸæœ‰ç»“æ„
        if ($slot_type === 'text') {
            $this->render_text_slot_with_card($slot_id, $slot, $units, $per_row, $max_display, $default_media, $text_color_options, $global_pause_purchase);
        } else {
            $this->render_image_slot_traditional($slot_id, $slot, $units, $per_row, $max_display, $default_media, $global_pause_purchase);
        }

        // ========================================
        // æ­¥éª¤ 4ï¼šç¼“å­˜æ¸²æŸ“ç»“æœ
        // ========================================
        $html_output = ob_get_clean();

        // ç¼“å­˜ï¼ˆé»˜è®¤ 1 å°æ—¶ï¼‰ï¼Œå¯é€šè¿‡è¿‡æ»¤å™¨è°ƒæ•´
        if (!(defined('ZIBLL_AD_DISABLE_CACHE') && ZIBLL_AD_DISABLE_CACHE)) {
            $ttl = apply_filters('zibll_ad_render_cache_ttl', 3600, $slot_id, $slot);
            set_transient($cache_key, $html_output, intval($ttl));
        }

        // è¾“å‡º HTML
        echo $html_output;

        // è°ƒè¯•ä¿¡æ¯ï¼ˆä»…ç®¡ç†å‘˜å¯è§ï¼‰
        if (defined('WP_DEBUG') && WP_DEBUG && current_user_can('manage_zibll_ads')) {
            echo "\n<!-- Zibll Ad Debug:\n";
            echo "Slot ID: {$slot_id}\n";
            echo "Type: {$slot_type}\n";
            echo "Layout: {$per_row} per row, {$rows} rows\n";
            echo "Units: {$max_display} total\n";
            echo "Cached: " . ($cached_html ? 'Yes' : 'No (Fresh Render)') . "\n";
            echo "Global Pause: " . ($global_pause_purchase ? 'Yes' : 'No') . "\n";
            echo "-->\n";
        }
    }

    /**
     * æ¸²æŸ“æ–‡å­—å‹å¹¿å‘Šä½ï¼ˆæ–°æ¨¡æ¿ - Card æ ·å¼ï¼‰
     *
     * ç›´æ¥è¾“å‡ºåˆ° theme-box å®¹å™¨å†…ï¼š
     * - card-head åŒ…å«æ ‡é¢˜å’Œ"ç«‹å³å…¥é©»"æŒ‰é’®
     * - card-body ä½¿ç”¨ posts-row ç½‘æ ¼å¸ƒå±€
     * - å“åº”å¼ï¼šç§»åŠ¨ç«¯2åˆ—ï¼ŒPCç«¯æ ¹æ®é…ç½®
     * - ä¸ä½¿ç”¨é¢å¤–çš„ .auto-ad-url å’Œ .card åŒ…è£…å±‚
     *
     * @param int   $slot_id               å¹¿å‘Šä½ ID
     * @param array $slot                  å¹¿å‘Šä½é…ç½®
     * @param array $units                 å¹¿å‘Šå•å…ƒæ•°æ®
     * @param int   $per_row               æ¯è¡Œæ•°é‡
     * @param int   $max_display           æœ€å¤§æ˜¾ç¤ºæ•°é‡
     * @param array $default_media         é»˜è®¤åª’ä½“é…ç½®
     * @param array $text_color_options    é¢œè‰²é€‰é¡¹
     * @param bool  $global_pause_purchase å…¨å±€æš‚åœè´­ä¹°
     */
    private function render_text_slot_with_card($slot_id, $slot, $units, $per_row, $max_display, $default_media, $text_color_options, $global_pause_purchase = false) {
        // è·å–å¹¿å‘Šä½æ ‡é¢˜ï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨é»˜è®¤æ ‡é¢˜
        $widget_title = isset($slot['widget_title']) && !empty($slot['widget_title'])
            ? $slot['widget_title']
            : 'æ°é¥­å¹¿å‘Š æ„Ÿè°¢æ”¯æŒ';
        ?>
        <!-- å¡ç‰‡å¤´éƒ¨ï¼šæ ‡é¢˜ + ç«‹å³å…¥é©»æŒ‰é’® -->
        <div class="card-head">
            <div class="text-sm">
                <span class="icon-hot">
                    <svg t="1759425764668" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2908" width="200" height="200"><path d="M484.4 171.4a518.98 518.98 0 0 0 116.5 205.5l5.6 5.6 63.8 77.8 34.2-91.3c5.6-19.6 13.4-39.2 19-61.6 101.2 97.5 141.9 242 106.4 378-12.7 51.3-42 97-83.4 129.9-63.9 53.4-145.3 81.1-228.5 77.8-99.5 4.4-195.6-36.9-261-112-9.6-9.2-17.7-19.8-24.1-31.4-55-81.5-63.3-185.8-21.8-275 12.5 13.1 25.8 25.4 39.8 37 7.8 8.4 16.8 14 21.8 19.6l119.8 122.1-23-168c-20.1-117.5 23.6-237.1 114.9-314z m44.8-107.5c-136.1 91.3-247.5 241.9-224 427.8-29.1-28.6-85.1-64.4-101.4-119.8C103.3 486.3 92.2 654.1 177 780.7c9.7 15.7 20.7 30.5 33 44.2 76.4 89.7 189.7 139.4 307.4 135 97 1.9 191.6-30.4 267.1-91.3 51.1-41.6 88-97.9 105.8-161.3 47.3-190.9-33.4-390.5-199.9-495-3.8 49.7-14.9 98.6-33 145C576.7 281 530.4 175 529.2 63.9z" fill="" p-id="2909"></path></svg>
                </span><?php echo esc_html($widget_title); ?>
            </div>
            <?php if (!$global_pause_purchase) : ?>
            <a href="javascript:void(0);"
               class="btn vc-yellow btn-outline ml-auto zibll-ad-purchase-trigger"
               data-slot="<?php echo esc_attr($slot_id); ?>">
                <span class="icon-ad-copy">
                    <svg t="1759425804622" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4823" width="200" height="200"><path d="M315.04 544h73.92L352 437.56 315.04 544zM704 512c-26.46 0-48 21.54-48 48s21.54 48 48 48 48-21.54 48-48-21.54-48-48-48zM928 128H96C43 128 0 171 0 224v576c0 53 43 96 96 96h832c53 0 96-43 96-96V224c0-53-43-96-96-96zM501.16 704h-33.88c-13.62 0-25.76-8.64-30.24-21.5L422.3 640h-140.58l-14.76 42.5A32 32 0 0 1 236.72 704h-33.88c-22.02 0-37.46-21.7-30.24-42.5L280 352.24A47.99 47.99 0 0 1 325.34 320h53.32A47.98 47.98 0 0 1 424 352.26l107.38 309.24c7.22 20.8-8.22 42.5-30.22 42.5zM848 672c0 17.68-14.32 32-32 32h-32c-9.7 0-18.08-4.54-23.96-11.36-17.24 7.32-36.18 11.36-56.04 11.36-79.4 0-144-64.6-144-144s64.6-144 144-144c16.92 0 32.92 3.46 48 8.84V352c0-17.68 14.32-32 32-32h32c17.68 0 32 14.32 32 32v320z" p-id="4824"></path></svg>
                </span>ç«‹å³å…¥é©»
            </a>
            <?php endif; ?>
        </div>

        <!-- å¡ç‰‡ä¸»ä½“ï¼šç½‘æ ¼å¸ƒå±€ -->
        <div class="card-body posts-row" data-per-row="<?php echo esc_attr($per_row); ?>">
            <?php
            // æ¸²æŸ“æ¯ä¸ªå¹¿å‘Šå•å…ƒ
            for ($i = 0; $i < $max_display; $i++) {
                $unit = isset($units[$i]) ? $units[$i] : null;
                $is_empty = !$unit || (isset($unit['is_empty']) && $unit['is_empty']);
                $unit_key = $unit ? (isset($unit['unit_key']) ? $unit['unit_key'] : $i) : $i;
                $status = $unit ? (isset($unit['status']) ? $unit['status'] : 'available') : 'available';

                if ($is_empty) {
                    // ç©ºä½æ ·å¼ï¼ˆå®Œå…¨å¤åˆ»æ¨¡æ¿ï¼‰
                    $empty_class = $global_pause_purchase ? 'auto-list-null' : 'auto-list-null zibll-ad-buy-trigger';
                    $empty_style = $global_pause_purchase ? 'cursor:default;opacity:0.6;' : 'cursor:pointer;';
                    ?>
                    <div class="<?php echo esc_attr($empty_class); ?>">
                        <div data-slot="<?php echo esc_attr($slot_id); ?>"
                             data-unit="<?php echo esc_attr($unit_key); ?>"
                             <?php if (!$global_pause_purchase) : ?>
                             class="zibll-ad-buy-trigger"
                             <?php endif; ?>
                             style="<?php echo esc_attr($empty_style); ?>">
                            <div class="auto-ad-img">
                                <svg viewBox="0 0 1024 1024" xmlns="http://www.w3.org/2000/svg">
                                    <path d="M315.04 544h73.92L352 437.56 315.04 544zM704 512c-26.46 0-48 21.54-48 48s21.54 48 48 48 48-21.54 48-48-21.54-48-48-48zM928 128H96C43 128 0 171 0 224v576c0 53 43 96 96 96h832c53 0 96-43 96-96V224c0-53-43-96-96-96zM501.16 704h-33.88c-13.62 0-25.76-8.64-30.24-21.5L422.3 640h-140.58l-14.76 42.5A32 32 0 0 1 236.72 704h-33.88c-22.02 0-37.46-21.7-30.24-42.5L280 352.24A47.99 47.99 0 0 1 325.34 320h53.32A47.98 47.98 0 0 1 424 352.26l107.38 309.24c7.22 20.8-8.22 42.5-30.22 42.5zM848 672c0 17.68-14.32 32-32 32h-32c-9.7 0-18.08-4.54-23.96-11.36-17.24 7.32-36.18 11.36-56.04 11.36-79.4 0-144-64.6-144-144s64.6-144 144-144c16.92 0 32.92 3.46 48 8.84V352c0-17.68 14.32-32 32-32h32c17.68 0 32 14.32 32 32v320z"></path>
                                </svg>
                            </div>
                            <div class="auto-ad-name"></div>
                        </div>
                    </div>
                    <?php
                } else {
                    // å·²å”®å¹¿å‘Šæ ·å¼ï¼ˆæŒ‰éœ€ï¼šå›¾æ ‡å§‹ç»ˆä¸ºé¦–å­—æ¯/é¦–å­—ç¬¦åœ†å½¢å¤´åƒï¼Œç™½è‰²æ–‡å­—ã€éšæœºèƒŒæ™¯è‰²ï¼‰
                    $website_name = isset($unit['website_name']) ? $unit['website_name'] : '';
                    $target_url = isset($unit['website_url']) ? $unit['website_url'] : '';
                    // æ ¹æ®è®¾ç½®ï¼Œå†³å®šæ˜¯å¦èµ° go.php é‡å®šå‘
                    if (!function_exists('zibll_ad_maybe_redirect_url')) {
                        require_once ZIBLL_AD_PATH . 'includes/helpers.php';
                    }
                    $final_url = zibll_ad_maybe_redirect_url($target_url);

                    // è·å–ç”¨æˆ·é€‰æ‹©çš„æ–‡å­—é¢œè‰²
                    $color_key = isset($unit['color_key']) ? $unit['color_key'] : '';
                    $text_color = $this->get_color_from_key($text_color_options, $color_key);

                    // å¦‚æœæ²¡æœ‰é€‰æ‹©é¢œè‰²æˆ–é¢œè‰²ä¸å­˜åœ¨ï¼Œä½¿ç”¨é»˜è®¤é¢œè‰²
                    $text_style = '';
                    if (!empty($text_color)) {
                        $text_style = ' style="color: ' . esc_attr($text_color) . '"';
                    }

                    // ç”Ÿæˆå›¾æ ‡å­—æ¯ä¸é¢œè‰²ï¼ˆé¢œè‰²åŸºäºç§å­ç”Ÿæˆï¼Œä¿è¯åŒä¸€å¹¿å‘Šç¨³å®šä¸€è‡´ï¼‰
                    $icon_letter = $this->get_icon_letter($website_name, '');
                    $avatar_bg   = $this->get_avatar_bg_color($slot_id . '|' . $unit_key . '|' . $website_name);
                    ?>
                    <div class="auto-list">
                        <a href="<?php echo esc_url($final_url); ?>"
                           target="_blank"
                           rel="nofollow noopener">
                            <div class="auto-ad-img" style="background-color: <?php echo esc_attr($avatar_bg); ?>; display:flex; align-items:center; justify-content:center; color:#fff; font-weight:600; line-height:1; font-size:12px;">
                                <?php echo esc_html($icon_letter); ?>
                            </div>
                            <div class="auto-ad-name"<?php echo $text_style; ?>><?php echo esc_html($website_name); ?></div>
                        </a>
                    </div>
                    <?php
                }
            }
            ?>
        </div>
        <?php
    }

    /**
     * æ¸²æŸ“å›¾ç‰‡å‹å¹¿å‘Šä½ï¼ˆæ–°æ¨¡æ¿ - Card å¸ƒå±€ï¼‰
     *
     * ç”¨æˆ·éœ€æ±‚æ›´æ–°ï¼š
     * - ä½¿ç”¨ç®€æ´çš„ card + ad-container + ad-item ç»“æ„
     * - æ¯ä¸ªå¹¿å‘Šä½¿ç”¨ aspect-ratio: 8 / 1 ä¿æŒæ¯”ä¾‹
     * - æ¯è¡Œæ•°é‡å’Œå±•ç¤ºè¡Œæ•°æŒ‰ç…§åå°è®¾ç½®
     * - é»˜è®¤æ˜¾ç¤ºåå°è®¾ç½®çš„é»˜è®¤å›¾ç‰‡
     *
     * @param int   $slot_id               å¹¿å‘Šä½ ID
     * @param array $slot                  å¹¿å‘Šä½é…ç½®
     * @param array $units                 å¹¿å‘Šå•å…ƒæ•°æ®
     * @param int   $per_row               æ¯è¡Œæ•°é‡
     * @param int   $max_display           æœ€å¤§æ˜¾ç¤ºæ•°é‡
     * @param array $default_media         é»˜è®¤åª’ä½“é…ç½®
     * @param bool  $global_pause_purchase å…¨å±€æš‚åœè´­ä¹°
     */
    private function render_image_slot_traditional($slot_id, $slot, $units, $per_row, $max_display, $default_media, $global_pause_purchase = false) {
        // è·å–é»˜è®¤å›¾ç‰‡ï¼ˆå­—æ®µåï¼šimage_urlï¼‰
        $default_image = isset($default_media['image_url']) && !empty($default_media['image_url'])
            ? $default_media['image_url']
            : '';

        // å¦‚æœæ²¡æœ‰è®¾ç½®é»˜è®¤å›¾ç‰‡ï¼Œä½¿ç”¨å ä½SVG
        if (empty($default_image)) {
            $default_image = 'data:image/svg+xml;base64,' . base64_encode(
                '<svg xmlns="http://www.w3.org/2000/svg" width="800" height="100" viewBox="0 0 800 100">
                    <rect fill="#f5f5f5" width="800" height="100"/>
                    <text x="50%" y="50%" fill="#909399" font-size="16" text-anchor="middle" dy=".3em">å¹¿å‘Šä½æ‹›ç§Ÿ</text>
                </svg>'
            );
        }

        $default_alt = isset($default_media['alt']) && !empty($default_media['alt'])
            ? $default_media['alt']
            : __('å¹¿å‘Šä½æ‹›ç§Ÿ', 'zibll-ad');

        // è·å–å¹¿å‘Šä½æ ‡é¢˜ï¼Œå¦‚æœä¸ºç©ºåˆ™ä½¿ç”¨é»˜è®¤æ ‡é¢˜
        $widget_title = isset($slot['widget_title']) && !empty($slot['widget_title'])
            ? $slot['widget_title']
            : 'æ°é¥­å¹¿å‘Š æ„Ÿè°¢æ”¯æŒ';

        ?>
        <!-- å¡ç‰‡å¤´éƒ¨ï¼šæ ‡é¢˜ + ç«‹å³å…¥é©»æŒ‰é’® -->
        <div class="card-head">
            <div class="text-sm">
                <span class="icon-hot">
                    <svg t="1759425764668" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="2908" width="200" height="200"><path d="M484.4 171.4a518.98 518.98 0 0 0 116.5 205.5l5.6 5.6 63.8 77.8 34.2-91.3c5.6-19.6 13.4-39.2 19-61.6 101.2 97.5 141.9 242 106.4 378-12.7 51.3-42 97-83.4 129.9-63.9 53.4-145.3 81.1-228.5 77.8-99.5 4.4-195.6-36.9-261-112-9.6-9.2-17.7-19.8-24.1-31.4-55-81.5-63.3-185.8-21.8-275 12.5 13.1 25.8 25.4 39.8 37 7.8 8.4 16.8 14 21.8 19.6l119.8 122.1-23-168c-20.1-117.5 23.6-237.1 114.9-314z m44.8-107.5c-136.1 91.3-247.5 241.9-224 427.8-29.1-28.6-85.1-64.4-101.4-119.8C103.3 486.3 92.2 654.1 177 780.7c9.7 15.7 20.7 30.5 33 44.2 76.4 89.7 189.7 139.4 307.4 135 97 1.9 191.6-30.4 267.1-91.3 51.1-41.6 88-97.9 105.8-161.3 47.3-190.9-33.4-390.5-199.9-495-3.8 49.7-14.9 98.6-33 145C576.7 281 530.4 175 529.2 63.9z" fill="" p-id="2909"></path></svg>
                </span><?php echo esc_html($widget_title); ?>
            </div>
            <?php if (!$global_pause_purchase) : ?>
            <a href="javascript:void(0);"
               class="btn vc-yellow btn-outline ml-auto zibll-ad-purchase-trigger"
               data-slot="<?php echo esc_attr($slot_id); ?>">
                <span class="icon-ad-copy">
                    <svg t="1759425804622" class="icon" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="4823" width="200" height="200"><path d="M315.04 544h73.92L352 437.56 315.04 544zM704 512c-26.46 0-48 21.54-48 48s21.54 48 48 48 48-21.54 48-48-21.54-48-48-48zM928 128H96C43 128 0 171 0 224v576c0 53 43 96 96 96h832c53 0 96-43 96-96V224c0-53-43-96-96-96zM501.16 704h-33.88c-13.62 0-25.76-8.64-30.24-21.5L422.3 640h-140.58l-14.76 42.5A32 32 0 0 1 236.72 704h-33.88c-22.02 0-37.46-21.7-30.24-42.5L280 352.24A47.99 47.99 0 0 1 325.34 320h53.32A47.98 47.98 0 0 1 424 352.26l107.38 309.24c7.22 20.8-8.22 42.5-30.22 42.5zM848 672c0 17.68-14.32 32-32 32h-32c-9.7 0-18.08-4.54-23.96-11.36-17.24 7.32-36.18 11.36-56.04 11.36-79.4 0-144-64.6-144-144s64.6-144 144-144c16.92 0 32.92 3.46 48 8.84V352c0-17.68 14.32-32 32-32h32c17.68 0 32 14.32 32 32v320z" p-id="4824"></path></svg>
                </span>ç«‹å³å…¥é©»
            </a>
            <?php endif; ?>
        </div>

        <!-- å›¾ç‰‡å‹å¹¿å‘Šä½å®¹å™¨ -->
        <div class="ad-container" data-per-row="<?php echo esc_attr($per_row); ?>">
            <?php
            for ($i = 0; $i < $max_display; $i++) {
                $unit = isset($units[$i]) ? $units[$i] : null;

                // åˆ¤æ–­æ˜¯å¦ä¸ºç©ºä½
                $is_empty = !$unit || (isset($unit['is_empty']) && $unit['is_empty']);
                $unit_key = $unit ? (isset($unit['unit_key']) ? $unit['unit_key'] : $i) : $i;
                $status = $unit ? (isset($unit['status']) ? $unit['status'] : 'available') : 'available';

                if ($is_empty || $status === 'available') {
                    // ç©ºä½ï¼šæ˜¾ç¤ºé»˜è®¤å›¾ç‰‡ï¼Œç‚¹å‡»å¯è´­ä¹°ï¼ˆé™¤éå…¨å±€æš‚åœï¼‰
                    $empty_class = $global_pause_purchase
                        ? 'ad-item ad-item-empty'
                        : 'ad-item ad-item-empty zibll-ad-buy-trigger';
                    $empty_style = $global_pause_purchase ? 'cursor:default;opacity:0.6;' : '';
                    $empty_tag = $global_pause_purchase ? 'div' : 'a';
                    $empty_attrs = $global_pause_purchase ? '' : 'href="javascript:void(0);"';
                    ?>
                    <?php if ($global_pause_purchase) : ?>
                    <div class="<?php echo esc_attr($empty_class); ?>"
                         data-slot="<?php echo esc_attr($slot_id); ?>"
                         data-unit="<?php echo esc_attr($unit_key); ?>"
                         title="<?php echo esc_attr($default_alt); ?>"
                         style="<?php echo esc_attr($empty_style); ?>">
                        <img src="<?php echo esc_url($default_image); ?>"
                             alt="<?php echo esc_attr($default_alt); ?>">
                    </div>
                    <?php else : ?>
                    <a href="javascript:void(0);"
                       class="<?php echo esc_attr($empty_class); ?>"
                       data-slot="<?php echo esc_attr($slot_id); ?>"
                       data-unit="<?php echo esc_attr($unit_key); ?>"
                       title="<?php echo esc_attr($default_alt); ?>">
                        <img src="<?php echo esc_url($default_image); ?>"
                             alt="<?php echo esc_attr($default_alt); ?>">
                    </a>
                    <?php endif; ?>
                    <?php
                } else {
                    // å·²å”®å¹¿å‘Šï¼šæ˜¾ç¤ºç”¨æˆ·ä¸Šä¼ çš„å›¾ç‰‡
                    $image_url = isset($unit['image_url']) && !empty($unit['image_url'])
                        ? $unit['image_url']
                        : $default_image;
                    $image_alt = isset($unit['website_name']) && !empty($unit['website_name'])
                        ? $unit['website_name']
                        : $default_alt;
                    $link_url = isset($unit['website_url']) && !empty($unit['website_url'])
                        ? $unit['website_url']
                        : '#';
                    // æ ¹æ®è®¾ç½®ï¼Œå†³å®šæ˜¯å¦èµ° go.php é‡å®šå‘
                    if (!function_exists('zibll_ad_maybe_redirect_url')) {
                        require_once ZIBLL_AD_PATH . 'includes/helpers.php';
                    }
                    $final_url = ($link_url && $link_url !== '#') ? zibll_ad_maybe_redirect_url($link_url) : $link_url;
                    ?>
                    <a href="<?php echo esc_url($final_url); ?>"
                       class="ad-item"
                       target="_blank"
                       rel="nofollow noopener"
                       title="<?php echo esc_attr($image_alt); ?>">
                        <img src="<?php echo esc_url($image_url); ?>"
                             alt="<?php echo esc_attr($image_alt); ?>">
                    </a>
                    <?php
                }
            }
            ?>
        </div>
        <?php
    }

    /**
     * æ¸²æŸ“å›¾ç‰‡å‹å¹¿å‘Šå•å…ƒ
     *
     * å¼€å‘æ–¹æ¡ˆè¦æ±‚ï¼š
     * - è¾“å‡º <a> åŒ…è£¹ <img>ï¼Œæä¾› data-unit/data-slot å±æ€§
     * - ç©ºä½ä½¿ç”¨é»˜è®¤æ‹›ç§Ÿå›¾
     *
     * @param array|null $unit          å•å…ƒæ•°æ®
     * @param bool       $is_empty      æ˜¯å¦ä¸ºç©ºä½
     * @param array      $default_media é»˜è®¤åª’ä½“é…ç½®
     */
    private function render_image_unit($unit, $is_empty, $default_media) {
        if ($is_empty) {
            // ç©ºä½ï¼šæ˜¾ç¤ºé»˜è®¤æ‹›ç§Ÿå›¾
            $image_url = isset($default_media['image_url']) ? $default_media['image_url'] : '';
            $image_alt = isset($default_media['alt']) ? $default_media['alt'] : __('å¹¿å‘Šä½æ‹›ç§Ÿ', 'zibll-ad');
            $link_url = isset($default_media['url']) ? $default_media['url'] : 'javascript:void(0)';
            $link_target = isset($default_media['url']) && $default_media['url'] ? '_blank' : '_self';

            // å¦‚æœæ²¡æœ‰é»˜è®¤å›¾ï¼Œä½¿ç”¨å ä½ç¬¦
            if (empty($image_url)) {
                $image_url = 'data:image/svg+xml;base64,' . base64_encode('
                    <svg xmlns="http://www.w3.org/2000/svg" width="400" height="300" viewBox="0 0 400 300">
                        <rect fill="#f0f2f5" width="400" height="300"/>
                        <text x="50%" y="50%" fill="#909399" font-size="18" text-anchor="middle" dy=".3em">å¹¿å‘Šä½æ‹›ç§Ÿ</text>
                    </svg>
                ');
            }
        } else {
            // å·²å”®å¹¿å‘Š
            $image_url = isset($unit['image_url']) ? $unit['image_url'] : '';
            $image_alt = isset($unit['website_name']) ? $unit['website_name'] : '';
            $link_url = isset($unit['website_url']) ? $unit['website_url'] : '';
            // æ ¹æ®è®¾ç½®ï¼Œå†³å®šæ˜¯å¦èµ° go.php é‡å®šå‘
            if (!function_exists('zibll_ad_maybe_redirect_url')) {
                require_once ZIBLL_AD_PATH . 'includes/helpers.php';
            }
            $link_url = zibll_ad_maybe_redirect_url($link_url);
            $link_target = '_blank';
        }

        // æ¸²æŸ“ HTML
        if ($link_url && $link_url !== 'javascript:void(0)') {
            ?>
            <a href="<?php echo esc_url($link_url); ?>"
               target="<?php echo esc_attr($link_target); ?>"
               rel="nofollow noopener"
               class="ad-link">
                <img src="<?php echo esc_url($image_url); ?>"
                     alt="<?php echo esc_attr($image_alt); ?>"
                     class="ad-image"
                     loading="lazy">
            </a>
            <?php
        } else {
            ?>
            <div class="ad-image-wrapper">
                <img src="<?php echo esc_url($image_url); ?>"
                     alt="<?php echo esc_attr($image_alt); ?>"
                     class="ad-image"
                     loading="lazy">
            </div>
            <?php
        }
    }


    /**
     * è·å–å®Œæ•´é¢œè‰²é€‰é¡¹ï¼ˆå«èƒŒæ™¯è‰²ï¼‰
     *
     * @param array  $color_options é¢œè‰²é€‰é¡¹æ•°ç»„
     * @param string $color_key     é¢œè‰²é”®
     * @return array|null é¢œè‰²é€‰é¡¹æ•°ç»„æˆ– null
     */
    private function get_color_option_from_key($color_options, $color_key) {
        if (empty($color_key) || !is_array($color_options)) {
            return null;
        }

        foreach ($color_options as $option) {
            if (isset($option['key']) && $option['key'] === $color_key) {
                return $option;
            }
        }

        return null;
    }

    /**
     * é¢œè‰²è½¬æµ…è‰²èƒŒæ™¯ï¼ˆè‡ªåŠ¨è®¡ç®—ï¼‰
     *
     * å°†æ·±è‰²æ–‡å­—é¢œè‰²è½¬æ¢ä¸ºå¯¹åº”çš„æµ…è‰²èƒŒæ™¯
     * ä¾‹å¦‚ï¼š#ff6b6b â†’ rgba(255, 107, 107, 0.1)
     *
     * @param string $color æ–‡å­—é¢œè‰²ï¼ˆHex æ ¼å¼ï¼‰
     * @return string èƒŒæ™¯è‰²ï¼ˆrgba æ ¼å¼ï¼‰
     */
    private function color_to_bg($color) {
        // ç§»é™¤ # å·
        $hex = ltrim($color, '#');

        // è½¬æ¢ä¸º RGB
        if (strlen($hex) === 3) {
            $r = hexdec(str_repeat(substr($hex, 0, 1), 2));
            $g = hexdec(str_repeat(substr($hex, 1, 1), 2));
            $b = hexdec(str_repeat(substr($hex, 2, 1), 2));
        } else {
            $r = hexdec(substr($hex, 0, 2));
            $g = hexdec(substr($hex, 2, 2));
            $b = hexdec(substr($hex, 4, 2));
        }

        // è¿”å› 10% é€æ˜åº¦çš„èƒŒæ™¯è‰²
        return sprintf('rgba(%d, %d, %d, 0.1)', $r, $g, $b);
    }

    /**
     * ç”Ÿæˆå›¾æ ‡å­—æ¯
     *
     * ä¼˜å…ˆçº§ï¼šç½‘ç«™åé¦–å­— â†’ æ–‡å­—å†…å®¹é¦–å­— â†’ A
     *
     * @param string $website_name ç½‘ç«™åç§°
     * @param string $text_content æ–‡å­—å†…å®¹
     * @return string å•ä¸ªå­—ç¬¦
     */
    private function get_icon_letter($website_name, $text_content) {
        // ä¼˜å…ˆä½¿ç”¨ç½‘ç«™å
        if (!empty($website_name)) {
            $first_char = mb_substr($website_name, 0, 1, 'UTF-8');
            if (!empty($first_char)) {
                return $first_char;
            }
        }

        // é™çº§ä½¿ç”¨æ–‡å­—å†…å®¹
        if (!empty($text_content)) {
            $first_char = mb_substr($text_content, 0, 1, 'UTF-8');
            if (!empty($first_char)) {
                return $first_char;
            }
        }

        // é»˜è®¤å­—æ¯
        return 'A';
    }

    /**
     * ä»é¢œè‰²é€‰é¡¹ä¸­è·å–é¢œè‰²ä»£ç 
     *
     * @param array  $color_options é¢œè‰²é€‰é¡¹æ•°ç»„
     * @param string $color_key     é¢œè‰²é”®
     * @return string é¢œè‰²ä»£ç ï¼ˆHex æ ¼å¼ï¼‰
     */
    private function get_color_from_key($color_options, $color_key) {
        if (empty($color_key) || !is_array($color_options)) {
            return '';
        }

        foreach ($color_options as $option) {
            if (isset($option['key']) && $option['key'] === $color_key) {
                return isset($option['color']) ? $option['color'] : '';
            }
        }

        return '';
    }

    /**
     * åå°è¡¨å•ï¼ˆWidget è®¾ç½®ç•Œé¢ï¼‰
     *
     * å¼€å‘æ–¹æ¡ˆè¦æ±‚ï¼š
     * - åå° widget é…ç½®ç•Œé¢ï¼ˆç®€å•æ˜¾ç¤º slot_idï¼Œæˆ–æä¾›ä¸‹æ‹‰é€‰æ‹©ï¼‰
     *
     * @param array $instance å½“å‰å®ä¾‹é…ç½®
     */
    public function form($instance) {
        $slot_id = isset($instance['slot_id']) ? intval($instance['slot_id']) : 0;
        $title = isset($instance['title']) ? $instance['title'] : '';

        ?>
        <p>
            <label for="<?php echo esc_attr($this->get_field_id('title')); ?>">
                <?php esc_html_e('æ ‡é¢˜ï¼ˆå¯é€‰ï¼‰ï¼š', 'zibll-ad'); ?>
            </label>
            <input
                class="widefat"
                id="<?php echo esc_attr($this->get_field_id('title')); ?>"
                name="<?php echo esc_attr($this->get_field_name('title')); ?>"
                type="text"
                value="<?php echo esc_attr($title); ?>"
                placeholder="<?php esc_attr_e('ç•™ç©ºåˆ™ä¸æ˜¾ç¤ºæ ‡é¢˜', 'zibll-ad'); ?>"
            >
        </p>

        <p>
            <label for="<?php echo esc_attr($this->get_field_id('slot_id')); ?>">
                <?php esc_html_e('å¹¿å‘Šä½ IDï¼š', 'zibll-ad'); ?>
            </label>
            <input
                class="widefat"
                id="<?php echo esc_attr($this->get_field_id('slot_id')); ?>"
                name="<?php echo esc_attr($this->get_field_name('slot_id')); ?>"
                type="number"
                value="<?php echo esc_attr($slot_id); ?>"
                readonly
                style="background-color: #f0f0f0; cursor: not-allowed;"
            >
            <small style="color:#666; display:block; margin-top:5px;">
                <?php esc_html_e('æ­¤ ID ç”±ç³»ç»Ÿè‡ªåŠ¨ç®¡ç†ï¼Œè¯·å‹¿æ‰‹åŠ¨ä¿®æ”¹', 'zibll-ad'); ?>
            </small>
        </p>

        <?php if ($slot_id && class_exists('Zibll_Ad_Slot_Model')): ?>
            <?php $slot = Zibll_Ad_Slot_Model::get($slot_id); ?>
            <?php if ($slot): ?>
                <div style="padding:12px; background:#f0f0f1; border-left:4px solid #2271b1; margin:10px 0; border-radius:4px;">
                    <strong style="display:block; margin-bottom:8px; color:#2271b1;">
                        ğŸ“Œ <?php echo esc_html($slot['title']); ?>
                    </strong>
                    <small style="color:#666; line-height:1.6;">
                        <strong><?php esc_html_e('ç±»å‹ï¼š', 'zibll-ad'); ?></strong>
                        <?php echo esc_html($slot['slot_type'] === 'image' ? __('å›¾ç‰‡', 'zibll-ad') : __('æ–‡å­—', 'zibll-ad')); ?>
                        <br>
                        <strong><?php esc_html_e('å•å…ƒæ•°ï¼š', 'zibll-ad'); ?></strong>
                        <?php echo esc_html(isset($slot['display_layout']['max_items']) ? $slot['display_layout']['max_items'] : 0); ?>
                        <br>
                        <strong><?php esc_html_e('å¸ƒå±€ï¼š', 'zibll-ad'); ?></strong>
                        <?php
                        if (isset($slot['display_layout']['per_row'])) {
                            echo esc_html(sprintf(
                                __('æ¯è¡Œ %d ä¸ª', 'zibll-ad'),
                                $slot['display_layout']['per_row']
                            ));
                        }
                        ?>
                    </small>
                </div>
            <?php else: ?>
                <div style="padding:12px; background:#fff3cd; border-left:4px solid #ffc107; color:#856404; border-radius:4px;">
                    âš ï¸ <?php esc_html_e('è­¦å‘Šï¼šå…³è”çš„å¹¿å‘Šä½ä¸å­˜åœ¨', 'zibll-ad'); ?>
                </div>
            <?php endif; ?>
        <?php endif; ?>

        <p style="margin-top:15px; padding-top:15px; border-top:1px solid #ddd;">
            <small style="color:#666; line-height:1.6;">
                ğŸ’¡ <?php esc_html_e('æç¤ºï¼šé€šè¿‡åå°"è‡ªåŠ©å¹¿å‘Šä½"èœå•å¯ä»¥ç®¡ç†å¹¿å‘Šä½çš„æŒ‚è½½ä½ç½®å’Œé…ç½®', 'zibll-ad'); ?>
            </small>
        </p>
        <?php
    }

    /**
     * åŸºäºç§å­ç”Ÿæˆç¨³å®šçš„ HSL é¢œè‰²ï¼ˆéšæœºä½†å¯å¤ç°ï¼‰
     *
     * @param string $seed
     * @return string e.g. hsl(210, 72%, 62%)
     */
    private function get_avatar_bg_color($seed) {
        $seed = (string) $seed;
        // ä½¿ç”¨ crc32 ä½œä¸ºè½»é‡ hash
        $hash = sprintf('%u', crc32($seed));
        $hue = intval($hash) % 360;     // 0-359
        $sat = 72;                      // äº®ä¸½ä¸€äº›
        $light = 62;                    // åäº®ï¼Œä¿è¯ç™½å­—å¯è¯»
        return 'hsl(' . $hue . ', ' . $sat . '%, ' . $light . '%)';
    }

    /**
     * æ›´æ–° Widget å®ä¾‹
     *
     * å¼€å‘æ–¹æ¡ˆè¦æ±‚ï¼š
     * - æ”¯æŒæ ‡é¢˜ä¿®æ”¹
     * - slot_id ç”±ç³»ç»Ÿç®¡ç†
     * - æ›´æ–°æ—¶æ¸…é™¤ç¼“å­˜
     *
     * @param array $new_instance æ–°çš„å®ä¾‹é…ç½®
     * @param array $old_instance æ—§çš„å®ä¾‹é…ç½®
     * @return array æ›´æ–°åçš„å®ä¾‹é…ç½®
     */
    public function update($new_instance, $old_instance) {
        $instance = array();

        // æ ‡é¢˜å¯ä»¥ç”±ç”¨æˆ·ä¿®æ”¹
        $instance['title'] = !empty($new_instance['title'])
            ? sanitize_text_field($new_instance['title'])
            : '';

        // slot_id ç”±ç³»ç»Ÿç®¡ç†ï¼Œä¿æŒä¸å˜
        $instance['slot_id'] = isset($old_instance['slot_id'])
            ? intval($old_instance['slot_id'])
            : 0;

        // å¦‚æœæ˜¯æ–°å®ä¾‹ä¸”æä¾›äº† slot_idï¼Œä½¿ç”¨æ–°çš„
        if (!$instance['slot_id'] && !empty($new_instance['slot_id'])) {
            $instance['slot_id'] = intval($new_instance['slot_id']);
        }

        // ========================================
        // æ¸…é™¤ç¼“å­˜ï¼ˆé‡è¦ï¼ï¼‰
        // ========================================
        if ($instance['slot_id']) {
            zibll_ad_clear_slot_cache($instance['slot_id']);
        }

        return $instance;
    }
}
